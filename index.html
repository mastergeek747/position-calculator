<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 투자 계산기</title>
    <style>
        /* 기본 스타일 초기화 및 설정 */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: #f7f9fc;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .main-container {
            width: 100%;
            max-width: 650px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .calculator-container, .history-container {
            width: 100%;
            background-color: #ffffff;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #eef;
            box-sizing: border-box;
        }
        h1, h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 30px;
        }
        
        /* 탭 네비게이션 스타일 */
        .tab-navigation {
            display: flex;
            background-color: #eef;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: -20px; /* 계산기 카드와 겹치게 */
            position: relative;
            z-index: 1;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background-color: transparent;
            color: #555;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
        }

        .tab-btn.active {
            background-color: #007bff;
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        /* 계산기 컨텐츠 숨기기/보이기 */
        .calculator-content {
            display: none;
        }
        .calculator-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 14px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.95em;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        td:first-child {
            text-align: left;
            background-color: #f9fafb;
            font-weight: 600;
            width: 45%; /* 너비 조정 */
        }
        input[type="number"], input[type="text"] {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
        }
        input[type="number"] {
             text-align: right;
        }
        input[type="text"] {
             text-align: right; /* 기본 정렬을 오른쪽으로 */
        }
        #investment-item, #position-item {
            text-align: center; /* 종목 입력만 가운데 정렬 */
        }
        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }
        #positionCalculator input {
            text-align: right;
            padding-right: 10px;
        }
        #positionCalculator input[type="text"] {
             text-align: right; /* 오른쪽 정렬로 통일 */
        }
        #position-item {
            text-align: center; /* 종목 입력만 가운데 정렬 */
        }

        .auto-field {
            font-weight: bold;
            font-size: 1.1em;
        }
        .final-investment {
            color: #d9534f;
            font-size: 1.2em;
        }
        .stop-loss-amount {
             color: #0056b3;
        }
        .total-capital-row {
            border-bottom: 2px solid #007bff;
        }
        .description-text {
            font-size: 0.8em;
            font-weight: normal;
            color: #777;
            margin-top: 4px;
        }

        /* 버튼 스타일 */
        .action-button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .save-button {
             background-color: #007bff;
        }
        .save-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .calculate-btn {
            background-color: #28a745;
        }
        .calculate-btn:hover {
            background-color: #1e7e34;
            transform: translateY(-2px);
        }


        /* 계산 내역 스타일 */
        .history-container h2 {
            color: #333;
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eef;
            border-radius: 8px;
            padding: 10px;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-item:hover {
            background-color: #f9f9ff;
        }
        .history-item-title {
            font-weight: 600;
        }
        .history-item-date {
            font-size: 0.85em;
            color: #777;
        }
        .clear-history-btn {
            width: auto;
            padding: 8px 16px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #d9534f;
            background-color: #fff;
            border: 1px solid #d9534f;
            border-radius: 5px;
            cursor: pointer;
            float: right;
            transition: background-color 0.2s, color 0.2s;
        }
        .clear-history-btn:hover {
            background-color: #d9534f;
            color: white;
        }
        
        /* 입력칸 + 초기화 버튼 스타일 */
        .input-with-button {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-with-button input {
            flex-grow: 1;
        }
        .reset-button {
            padding: 8px 12px;
            font-size: 0.9em;
            border: 1px solid #ddd;
            background-color: #f8f8f8;
            border-radius: 5px;
            cursor: pointer;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        .reset-button:hover {
            background-color: #eee;
        }
        
        /* 결과 및 설명 섹션 스타일 */
        .results-section, .explanation-section { 
            margin-top: 1.5rem; 
            padding-top: 1.5rem; 
            border-top: 1px solid #e2e8f0; 
        }
        .explanation-section {
             text-align: left;
        }
        .explanation-section h2 {
            text-align: center;
            margin-bottom: 1rem;
        }
        .explanation-section p {
            margin-bottom: 1rem;
            color: #4a5568;
            font-size: 0.95em;
            line-height: 1.7;
        }
        .explanation-section b {
            color: #2d3748;
        }
        #positionCalculator .results-section td:first-child { font-weight: 600; color: #4a5568;}
        #positionCalculator .auto-field { background-color: #f7fafc; color: #2d3748; font-weight: 700; border: 1px solid #e2e8f0; padding:8px; border-radius: 5px; display: block; text-align: right; }
        .error-message { color: red; font-size: 0.9rem; text-align: center; margin-top: 10px; height: 20px; }


        /* 모바일 반응형 디자인 */
        @media (max-width: 600px) {
            body { padding: 1rem; }
            .calculator-container, .history-container { padding: 1.5rem; }
            h1 { font-size: 1.5rem; }
            th, td { padding: 8px; font-size: 0.85em; }
            .tab-btn { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="showCalculator('riskCalculator')">리스크 관리</button>
            <button class="tab-btn" onclick="showCalculator('positionCalculator')">포지션 크기</button>
        </div>

        <div class="calculator-container">
            <!-- 리스크 관리 투자 계산기 -->
            <div id="riskCalculator" class="calculator-content active">
                <h1>리스크 관리 투자 계산기</h1>
                <table>
                    <thead>
                        <tr>
                            <th>항목</th>
                            <th>원화 (KRW)</th>
                            <th>달러 (USD)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="total-capital-row">
                            <td>총 투자금액 (입력)</td>
                            <td><input type="number" id="won-total-capital" placeholder="10,000,000"></td>
                            <td><input type="number" id="usd-total-capital" placeholder="10,000"></td>
                        </tr>
                        <tr class="total-capital-row">
                            <td>
                                리스크 비율 (입력) [%]
                                <div class="description-text">기본값 1% (1-3% 추천)</div>
                            </td>
                            <td><input type="number" id="won-risk-percent" value="1" step="0.1"></td>
                            <td><input type="number" id="usd-risk-percent" value="1" step="0.1"></td>
                        </tr>
                        <tr>
                            <td>손절금액 (자동)</td>
                            <td class="auto-field stop-loss-amount" id="won-stop-loss-amount">---</td>
                            <td class="auto-field stop-loss-amount" id="usd-stop-loss-amount">---</td>
                        </tr>
                        <tr>
                            <td>투자 종목 (입력)</td>
                            <td colspan="2">
                                <div class="input-with-button">
                                    <input type="text" id="investment-item" placeholder="예: 삼성전자, 비트코인">
                                    <button id="reset-prices-btn" class="reset-button" title="진입가/청산가 초기화">초기화</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>진입가 (입력)</td>
                            <td><input type="number" id="won-entry" placeholder="585,000"></td>
                            <td><input type="number" id="usd-entry" placeholder="10,000"></td>
                        </tr>
                        <tr>
                            <td>청산가 (입력)</td>
                            <td><input type="number" id="won-exit" placeholder="516,000"></td>
                            <td><input type="number" id="usd-exit" placeholder="9,000"></td>
                        </tr>
                        <tr>
                            <td>
                                소모비용 (입력) [%]
                                <div class="description-text">수수료 등 발생하는 비용</div>
                            </td>
                            <td><input type="number" id="won-cost" value="1" step="0.1"></td>
                            <td><input type="number" id="usd-cost" value="1" step="0.1"></td>
                        </tr>
                        <tr>
                            <td>손절폭 (자동)</td>
                            <td class="auto-field" id="won-stop-loss-percent">---</td>
                            <td class="auto-field" id="usd-stop-loss-percent">---</td>
                        </tr>
                        <tr>
                            <td><strong>1회 투자금액 (자동)</strong></td>
                            <td class="auto-field final-investment" id="won-investment">---</td>
                            <td class="auto-field final-investment" id="usd-investment">---</td>
                        </tr>
                    </tbody>
                </table>
                <button id="save-history-btn" class="action-button save-button">계산 내역 저장</button>
            </div>
            
            <!-- 포지션 크기 계산기 (스타일 변경됨) -->
            <div id="positionCalculator" class="calculator-content">
                 <h1>포지션 크기 계산기</h1>
                 <table>
                     <tbody>
                        <tr>
                            <td>투자 종목</td>
                            <td>
                                <div class="input-with-button">
                                    <input type="text" id="position-item" placeholder="예: Apple, Tesla">
                                    <button id="reset-position-btn" class="reset-button" title="입력값 초기화">초기화</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>총 투자금액 ($)</td>
                            <td><input type="number" id="balance" placeholder="1,000"></td>
                        </tr>
                        <tr>
                            <td>
                                손절매 (%)
                                <div class="description-text">포지션 규모 계산에 사용</div>
                            </td>
                            <td><input type="number" id="stopLoss" placeholder="2.5"></td>
                        </tr>
                        <tr>
                            <td>
                                위험 수준 (%)
                                <div class="description-text">최대 손실액 계산에 사용</div>
                            </td>
                            <td><input type="number" id="riskLevel" value="1"></td>
                        </tr>
                        <tr>
                            <td>레버리지 (x)</td>
                            <td><input type="number" id="leverage" placeholder="20"></td>
                        </tr>
                     </tbody>
                 </table>

                <button class="action-button calculate-btn" onclick="calculateAndSavePosition()">계산 및 내역 저장</button>
                <div id="position-error" class="error-message"></div>

                <div class="results-section">
                    <h2>계산 결과</h2>
                    <table>
                        <tbody>
                            <tr>
                                <td>최대 손실 ($)</td>
                                <td id="maxLoss" class="auto-field"></td>
                            </tr>
                            <tr>
                                <td>총 포지션 규모 ($)</td>
                                <td id="positionSize" class="auto-field"></td>
                            </tr>
                            <tr>
                                <td>필수 증거금 ($)</td>
                                <td id="requiredMargin" class="auto-field"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="explanation-section">
                    <h2>입력 설명</h2>
                    <p><b>총 투자금액 ($):</b> 레버리지를 제외한 실제 계좌에 보유하고 있는 총 자산입니다.</p>
                    <p><b>손절매 (%):</b> 최대 손실액을 바탕으로, 진입할 총 포지션의 크기를 결정합니다. 손절매 폭이 좁을수록 포지션 규모는 커집니다.</p>
                    <p><b>위험 수준 (%):</b> 총 투자금액 대비 이번 거래에서 감수할 최대 손실 비율(%)을 설정합니다. 이 비율로 실제 최대 손실 금액($)이 결정됩니다.</p>
                    <p><b>레버리지 (x):</b> 거래소에서 사용하는 자본금의 배수입니다. 레버리지는 수익과 손실을 모두 증폭시키므로 신중하게 사용해야 합니다.</p>
                </div>
            </div>

        </div>
        
        <div class="history-container" id="history-container">
            <h2 id="history-title">계산 내역</h2>
            <div class="history-list" id="history-list">
                <!-- 계산 내역이 여기에 동적으로 추가됩니다. -->
            </div>
            <button id="clear-history-btn" class="clear-history-btn">내역 전체 삭제</button>
        </div>

    </div>

    <script>
        // --- Helper functions for number formatting ---
        const unformat = (value) => {
            if (value === null || value === undefined) return '';
            return String(value).replace(/,/g, '');
        };

        function formatNumber(value) {
            if (value === null || value === undefined || value === '') return '';
            let stringValue = String(value);
            
            let parts = stringValue.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }


        // --- 탭 전환 로직 ---
        function showCalculator(calculatorId) {
            document.querySelectorAll('.calculator-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById(calculatorId).classList.add('active');
            document.querySelector(`.tab-btn[onclick="showCalculator('${calculatorId}')"]`).classList.add('active');
            
            const historyContainer = document.getElementById('history-container');
            const historyTitle = document.getElementById('history-title');
            const clearBtn = document.getElementById('clear-history-btn');

            if (calculatorId === 'riskCalculator') {
                historyTitle.textContent = '계산 내역 (리스크 관리)';
                loadRiskHistory();
                clearBtn.onclick = clearRiskHistory;
                historyContainer.style.display = 'block';
            } else if (calculatorId === 'positionCalculator') {
                historyTitle.textContent = '계산 내역 (포지션 크기)';
                loadPositionHistory();
                clearBtn.onclick = clearPositionHistory;
                historyContainer.style.display = 'block';
            }
        }

        // --- 리스크 관리 내역 로직 ---
        const riskHistoryKey = 'riskInvestmentHistory';

        function saveRiskHistory() {
            const historyEntry = {
                id: Date.now(),
                date: new Date().toLocaleString('ko-KR'),
                item: document.getElementById('investment-item').value || '이름 없는 계획',
                wonCapital: document.getElementById('won-total-capital').value,
                usdCapital: document.getElementById('usd-total-capital').value,
                wonRisk: document.getElementById('won-risk-percent').value,
                usdRisk: document.getElementById('usd-risk-percent').value,
                wonEntry: document.getElementById('won-entry').value,
                usdEntry: document.getElementById('usd-entry').value,
                wonExit: document.getElementById('won-exit').value,
                usdExit: document.getElementById('usd-exit').value,
                wonCost: document.getElementById('won-cost').value,
                usdCost: document.getElementById('usd-cost').value,
            };

            let history = JSON.parse(localStorage.getItem(riskHistoryKey)) || [];
            history.unshift(historyEntry);
            localStorage.setItem(riskHistoryKey, JSON.stringify(history));
            loadRiskHistory();
        }

        function loadRiskHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            let history = JSON.parse(localStorage.getItem(riskHistoryKey)) || [];
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align:center; color:#999;">저장된 내역이 없습니다.</p>';
                return;
            }

            history.forEach(entry => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.innerHTML = `
                    <span class="history-item-title">${entry.item}</span>
                    <span class="history-item-date">${entry.date}</span>
                `;
                itemDiv.onclick = () => restoreRiskHistory(entry.id);
                historyList.appendChild(itemDiv);
            });
        }
        
        function restoreRiskHistory(id) {
            let history = JSON.parse(localStorage.getItem(riskHistoryKey)) || [];
            const entry = history.find(e => e.id === id);
            if (entry) {
                document.getElementById('investment-item').value = entry.item;
                document.getElementById('won-total-capital').value = formatNumber(entry.wonCapital);
                document.getElementById('usd-total-capital').value = formatNumber(entry.usdCapital);
                document.getElementById('won-risk-percent').value = entry.wonRisk;
                document.getElementById('usd-risk-percent').value = entry.usdRisk;
                document.getElementById('won-entry').value = formatNumber(entry.wonEntry);
                document.getElementById('usd-entry').value = formatNumber(entry.usdEntry);
                document.getElementById('won-exit').value = formatNumber(entry.wonExit);
                document.getElementById('usd-exit').value = formatNumber(entry.usdExit);
                document.getElementById('won-cost').value = entry.wonCost;
                document.getElementById('usd-cost').value = entry.usdCost;
                calculateRisk();
                window.scrollTo(0, 0);
            }
        }

        function clearRiskHistory() {
            localStorage.removeItem(riskHistoryKey);
            loadRiskHistory();
        }

        // --- 포지션 크기 내역 로직 ---
        const positionHistoryKey = 'positionHistory';

        function savePositionHistory() {
             const historyEntry = {
                id: Date.now(),
                date: new Date().toLocaleString('ko-KR'),
                item: document.getElementById('position-item').value || '이름 없는 계획',
                balance: document.getElementById('balance').value,
                stopLoss: document.getElementById('stopLoss').value,
                riskLevel: document.getElementById('riskLevel').value,
                leverage: document.getElementById('leverage').value,
            };
            let history = JSON.parse(localStorage.getItem(positionHistoryKey)) || [];
            history.unshift(historyEntry);
            localStorage.setItem(positionHistoryKey, JSON.stringify(history));
            loadPositionHistory();
        }

        function loadPositionHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            let history = JSON.parse(localStorage.getItem(positionHistoryKey)) || [];

            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align:center; color:#999;">저장된 내역이 없습니다.</p>';
                return;
            }
            history.forEach(entry => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.innerHTML = `
                    <span class="history-item-title">${entry.item}</span>
                    <span class="history-item-date">${entry.date}</span>
                `;
                itemDiv.onclick = () => restorePositionHistory(entry.id);
                historyList.appendChild(itemDiv);
            });
        }

        function restorePositionHistory(id) {
            let history = JSON.parse(localStorage.getItem(positionHistoryKey)) || [];
            const entry = history.find(e => e.id === id);
            if(entry) {
                document.getElementById('position-item').value = entry.item;
                document.getElementById('balance').value = formatNumber(entry.balance);
                document.getElementById('stopLoss').value = entry.stopLoss;
                document.getElementById('riskLevel').value = entry.riskLevel;
                document.getElementById('leverage').value = entry.leverage;
                calculatePosition(false);
                window.scrollTo(0, 0);
            }
        }

        function clearPositionHistory(){
            localStorage.removeItem(positionHistoryKey);
            loadPositionHistory();
        }

        
        // --- 가격 초기화 로직 ---
        function resetPrices() {
            document.getElementById('won-entry').value = '';
            document.getElementById('usd-entry').value = '';
            document.getElementById('won-exit').value = '';
            document.getElementById('usd-exit').value = '';
            calculateRisk();
        }
        
        // --- 포지션 크기 입력값 초기화 로직 ---
        function resetPositionInputs() {
            document.getElementById('position-item').value = '';
            document.getElementById('balance').value = '';
            document.getElementById('stopLoss').value = '';
            document.getElementById('riskLevel').value = '';
            document.getElementById('leverage').value = '';
            calculatePosition(false);
        }

        // --- 리스크 관리 계산기 로직 ---
        function calculateRisk() {
            const wonTotalCapital = parseFloat(unformat(document.getElementById('won-total-capital').value)) || 0;
            const wonRiskPercent = parseFloat(unformat(document.getElementById('won-risk-percent').value)) || 0;
            const wonEntry = parseFloat(unformat(document.getElementById('won-entry').value)) || 0;
            const wonExit = parseFloat(unformat(document.getElementById('won-exit').value)) || 0;
            const wonCostPercent = parseFloat(unformat(document.getElementById('won-cost').value)) || 0;

            const wonStopLossAmount = wonTotalCapital * (wonRiskPercent / 100);
            document.getElementById('won-stop-loss-amount').textContent = wonStopLossAmount.toLocaleString('ko-KR', { maximumFractionDigits: 0 });

            if (wonEntry > 0) {
                const priceLossRate = Math.abs(wonEntry - wonExit) / wonEntry;
                const costRate = wonCostPercent / 100;
                const totalLossRate = priceLossRate + costRate;
                document.getElementById('won-stop-loss-percent').textContent = (totalLossRate * 100).toFixed(2) + '%';
                
                const investment = (totalLossRate > 0) ? (wonStopLossAmount / totalLossRate) : 0;
                document.getElementById('won-investment').textContent = Math.round(investment).toLocaleString('ko-KR');
            } else {
                document.getElementById('won-stop-loss-percent').textContent = '0.00%';
                document.getElementById('won-investment').textContent = '0';
            }

            const usdTotalCapital = parseFloat(unformat(document.getElementById('usd-total-capital').value)) || 0;
            const usdRiskPercent = parseFloat(unformat(document.getElementById('usd-risk-percent').value)) || 0;
            const usdEntry = parseFloat(unformat(document.getElementById('usd-entry').value)) || 0;
            const usdExit = parseFloat(unformat(document.getElementById('usd-exit').value)) || 0;
            const usdCostPercent = parseFloat(unformat(document.getElementById('usd-cost').value)) || 0;

            const usdStopLossAmount = usdTotalCapital * (usdRiskPercent / 100);
            document.getElementById('usd-stop-loss-amount').textContent = usdStopLossAmount.toLocaleString('en-US', { maximumFractionDigits: 2 });
            
            if (usdEntry > 0) {
                const priceLossRateUSD = Math.abs(usdEntry - usdExit) / usdEntry;
                const costRateUSD = usdCostPercent / 100;
                const totalLossRateUSD = priceLossRateUSD + costRateUSD;
                document.getElementById('usd-stop-loss-percent').textContent = (totalLossRateUSD * 100).toFixed(2) + '%';
                
                const investmentUSD = (totalLossRateUSD > 0) ? (usdStopLossAmount / totalLossRateUSD) : 0;
                document.getElementById('usd-investment').textContent = Math.round(investmentUSD).toLocaleString('en-US');
            } else {
                document.getElementById('usd-stop-loss-percent').textContent = '0.00%';
                document.getElementById('usd-investment').textContent = '0';
            }
        }

        // --- 포지션 크기 계산기 로직 ---
        function calculatePosition(shouldSave = true) {
            const balance = parseFloat(unformat(document.getElementById('balance').value)) || 0;
            const stopLossPercent = parseFloat(unformat(document.getElementById('stopLoss').value)) || 0;
            const riskLevelPercent = parseFloat(unformat(document.getElementById('riskLevel').value)) || 0;
            const leverage = parseFloat(unformat(document.getElementById('leverage').value)) || 0;
            const errorDiv = document.getElementById('position-error');

            if (isNaN(balance) || isNaN(stopLossPercent) || isNaN(riskLevelPercent) || isNaN(leverage) || balance <= 0 || stopLossPercent <= 0 || riskLevelPercent <= 0 || leverage < 1) {
                document.getElementById('maxLoss').textContent = '';
                document.getElementById('positionSize').textContent = '';
                document.getElementById('requiredMargin').textContent = '';
                if(shouldSave) {
                    errorDiv.textContent = '모든 필드에 유효한 숫자를 입력해주세요.';
                    setTimeout(() => { errorDiv.textContent = '' }, 3000);
                }
                return false;
            }
            errorDiv.textContent = '';
            const maxLoss = balance * (riskLevelPercent / 100);
            const positionSize = maxLoss / (stopLossPercent / 100);
            const requiredMargin = positionSize / leverage;
            document.getElementById('maxLoss').textContent = `$${maxLoss.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
            document.getElementById('positionSize').textContent = `$${positionSize.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
            document.getElementById('requiredMargin').textContent = `$${requiredMargin.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
            return true;
        }
        
        function calculateAndSavePosition() {
            const success = calculatePosition(true);
            if (success) {
                savePositionHistory();
            }
        }
        
        // --- 이벤트 리스너 설정 ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('save-history-btn').addEventListener('click', saveRiskHistory);
            document.getElementById('clear-history-btn').addEventListener('click', clearRiskHistory);
            document.getElementById('reset-prices-btn').addEventListener('click', resetPrices);
            document.getElementById('reset-position-btn').addEventListener('click', resetPositionInputs);

            const riskCalcInputs = document.querySelectorAll('#riskCalculator input');
            riskCalcInputs.forEach(input => {
                input.addEventListener('input', calculateRisk);
            });
            
            const positionInputs = document.querySelectorAll('#positionCalculator input');
            positionInputs.forEach(input => {
                input.addEventListener('input', () => calculatePosition(false));
            });
            
            const inputsToFormat = [
                'won-total-capital', 'usd-total-capital', 'won-entry', 
                'usd-entry', 'won-exit', 'usd-exit', 'balance'
            ];
            
            inputsToFormat.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.type = 'text'; // 콤마 사용을 위해 text 타입으로 변경
                    input.setAttribute('inputmode', 'decimal'); // 모바일 키보드 최적화
                    input.addEventListener('input', (e) => {
                        const originalValue = e.target.value;
                        const unformatted = unformat(originalValue);
                        if (isNaN(unformatted) && unformatted !== '') { // 숫자 아닌 값 입력 방지
                            e.target.value = originalValue.slice(0, -1);
                            return;
                        }
                        const formatted = formatNumber(unformatted);
                        if (originalValue !== formatted) {
                            e.target.value = formatted;
                        }
                    });
                }
            });

            showCalculator('riskCalculator');
            calculateRisk();
        });
    </script>
</body>
</html>


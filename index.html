<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 투자 계산기</title>
    <style>
        /* 기본 스타일 초기화 및 설정 */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: #f7f9fc;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .main-container {
            width: 100%;
            max-width: 650px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .calculator-container, .history-container {
            width: 100%;
            background-color: #ffffff;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #eef;
            box-sizing: border-box;
        }
        h1, h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 30px;
        }
        
        /* 탭 네비게이션 스타일 */
        .tab-navigation {
            display: flex;
            background-color: #eef;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: -20px; /* 계산기 카드와 겹치게 */
            position: relative;
            z-index: 1;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background-color: transparent;
            color: #555;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
        }

        .tab-btn.active {
            background-color: #007bff;
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        /* 계산기 컨텐츠 숨기기/보이기 */
        .calculator-content {
            display: none;
        }
        .calculator-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 14px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.95em;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        td:first-child {
            text-align: left;
            background-color: #f9fafb;
            font-weight: 600;
            width: 45%; /* 너비 조정 */
        }
        input[type="number"], input[type="text"], select {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
        }
        input[type="number"], input[type="text"] {
             text-align: right; /* 기본 정렬을 오른쪽으로 */
        }
        #investment-item, #position-item, #roi-item {
            text-align: center; /* 종목 입력만 가운데 정렬 */
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }
       
        .auto-field {
            font-weight: bold;
            font-size: 1.1em;
        }
        .final-investment {
            color: #d9534f;
            font-size: 1.2em;
        }
        .stop-loss-amount {
             color: #0056b3;
        }
        .total-capital-row {
            border-bottom: 2px solid #007bff;
        }
        .description-text {
            font-size: 0.8em;
            font-weight: normal;
            color: #777;
            margin-top: 4px;
        }

        /* 버튼 스타일 */
        .action-button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .save-button {
             background-color: #007bff;
        }
        .save-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        /* 계산 내역 스타일 */
        .history-container h2 {
            color: #333;
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eef;
            border-radius: 8px;
            padding: 10px;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-item:hover {
            background-color: #f9f9ff;
        }
        .history-item-title {
            font-weight: 600;
        }
        .history-item-date {
            font-size: 0.85em;
            color: #777;
        }
        .clear-history-btn {
            width: auto;
            padding: 8px 16px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #d9534f;
            background-color: #fff;
            border: 1px solid #d9534f;
            border-radius: 5px;
            cursor: pointer;
            float: right;
            transition: background-color 0.2s, color 0.2s;
        }
        .clear-history-btn:hover {
            background-color: #d9534f;
            color: white;
        }
        
        /* 입력칸 + 초기화 버튼 스타일 */
        .input-with-button {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-with-button input {
            flex-grow: 1;
        }
        .reset-button {
            padding: 8px 12px;
            font-size: 0.9em;
            border: 1px solid #ddd;
            background-color: #f8f8f8;
            border-radius: 5px;
            cursor: pointer;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        .reset-button:hover {
            background-color: #eee;
        }
        
        /* 결과 및 설명 섹션 스타일 */
        .results-section, .explanation-section { 
            margin-top: 1.5rem; 
            padding-top: 1.5rem; 
            border-top: 1px solid #e2e8f0; 
        }
        .explanation-section {
             text-align: left;
        }
        .explanation-section h2 {
            text-align: center;
            margin-bottom: 1rem;
        }
        .explanation-section p {
            margin-bottom: 1rem;
            color: #4a5568;
            font-size: 0.95em;
            line-height: 1.7;
        }
        .explanation-section b {
            color: #2d3748;
        }
        #positionCalculator .results-section td:first-child { font-weight: 600; color: #4a5568;}
        #positionCalculator .auto-field { 
            background-color: #f7fafc; 
            color: #2d3748; 
            font-weight: 700; 
            border: 1px solid #e2e8f0; 
            padding: 8px 14px; 
            border-radius: 5px; 
            display: block; 
            text-align: right; 
        }
        .error-message { color: red; font-size: 0.9rem; text-align: center; margin-top: 10px; height: 20px; }

        /* 모바일 반응형 디자인 */
        @media (max-width: 650px) {
            body { padding: 10px; }
            .calculator-container, .history-container { padding: 20px; }
            h1 { font-size: 1.5rem; }
            .tab-btn { font-size: 0.9rem; }

            /* 반응형 테이블 스타일 */
            .responsive-table thead {
                display: none;
            }
            .responsive-table tr {
                display: block;
                border-bottom: 2px solid #007bff;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
            }
             .responsive-table tr:last-child {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: none;
            }
            .responsive-table td {
                display: block;
                text-align: right;
                border: none;
                padding: 5px;
                position: relative;
                padding-left: 50%;
            }
            .responsive-table td:first-child {
                padding: 10px 0;
                margin-bottom: 10px;
                text-align: left;
                font-size: 1.1em;
                font-weight: 600;
                color: #333;
                background-color: transparent;
                border-bottom: 1px solid #eee;
            }
            .responsive-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 5px;
                width: calc(50% - 10px);
                text-align: left;
                font-weight: 600;
                color: #555;
            }
             .responsive-table td:first-child::before,
             .responsive-table td[colspan="2"]::before,
             .responsive-table .no-label::before {
                display: none;
            }
            .responsive-table td[colspan="2"] {
                padding-left: 5px;
            }
             .input-with-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="showCalculator('riskCalculator')">리스크 관리</button>
            <button class="tab-btn" onclick="showCalculator('positionCalculator')">포지션 크기</button>
            <button class="tab-btn" onclick="showCalculator('roiCalculator')">수익률 계산기</button>
        </div>

        <div class="calculator-container">
            <!-- ===== 1) 리스크 관리 ===== -->
            <div id="riskCalculator" class="calculator-content active">
                <h1>리스크 관리 투자 계산기</h1>
                <table class="responsive-table">
                    <thead>
                        <tr><th>항목</th><th>원화 (KRW)</th><th>달러 (USD)</th></tr>
                    </thead>
                    <tbody>
                        <tr class="total-capital-row">
                            <td>총 투자금액 (입력)</td>
                            <td data-label="원화 (KRW)"><input type="text" id="won-total-capital" placeholder="10,000,000"></td>
                            <td data-label="달러 (USD)"><input type="text" id="usd-total-capital" placeholder="10,000"></td>
                        </tr>
                        <tr class="total-capital-row">
                            <td>리스크 비율 (입력) [%] <div class="description-text">기본값 1% (1-3% 추천)</div></td>
                            <td data-label="원화 (KRW)"><input type="number" id="won-risk-percent" placeholder="1" step="0.1"></td>
                            <td data-label="달러 (USD)"><input type="number" id="usd-risk-percent" placeholder="1" step="0.1"></td>
                        </tr>
                        <tr>
                            <td>손절금액 (자동)</td>
                            <td data-label="원화 (KRW)" class="auto-field stop-loss-amount" id="won-stop-loss-amount">---</td>
                            <td data-label="달러 (USD)" class="auto-field stop-loss-amount" id="usd-stop-loss-amount">---</td>
                        </tr>
                        <tr>
                            <td>투자 종목 (입력)</td>
                            <td colspan="2">
                                <div class="input-with-button">
                                    <input type="text" id="investment-item" placeholder="예: 삼성전자, 비트코인">
                                    <button id="reset-prices-btn" class="reset-button" title="입력값 초기화">초기화</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>진입가 (입력)</td>
                            <td data-label="원화 (KRW)"><input type="text" id="won-entry" placeholder="585,000"></td>
                            <td data-label="달러 (USD)"><input type="text" id="usd-entry" placeholder="10,000"></td>
                        </tr>
                        <tr>
                            <td>청산가 (입력)</td>
                            <td data-label="원화 (KRW)"><input type="text" id="won-exit" placeholder="516,000"></td>
                            <td data-label="달러 (USD)"><input type="text" id="usd-exit" placeholder="9,000"></td>
                        </tr>
                        <tr>
                            <td>소모비용 (입력) [%] <div class="description-text">수수료 등 발생하는 비용(왕복)</div></td>
                            <td data-label="원화 (KRW)"><input type="number" id="won-cost" placeholder="0.1" step="0.1"></td>
                            <td data-label="달러 (USD)"><input type="number" id="usd-cost" placeholder="0.1" step="0.1"></td>
                        </tr>
                        <tr>
                            <td>손절폭 (자동)</td>
                            <td data-label="원화 (KRW)" class="auto-field" id="won-stop-loss-percent">---</td>
                            <td data-label="달러 (USD)" class="auto-field" id="usd-stop-loss-percent">---</td>
                        </tr>
                        <tr>
                            <td><strong>1회 투자금액 (자동)</strong></td>
                            <td data-label="원화 (KRW)" class="auto-field final-investment" id="won-investment">---</td>
                            <td data-label="달러 (USD)" class="auto-field final-investment" id="usd-investment">---</td>
                        </tr>
                    </tbody>
                </table>
                <button id="save-risk-history-btn" class="action-button save-button">계산 내역 저장</button>
            </div>

            <!-- ===== 2) 포지션 크기 ===== -->
            <div id="positionCalculator" class="calculator-content">
                <h1>포지션 크기 계산기</h1>
                <table class="responsive-table">
                    <tbody>
                        <tr>
                            <td>투자 종목</td>
                            <td class="no-label">
                                <div class="input-with-button">
                                    <input type="text" id="position-item" placeholder="예: Apple, Tesla">
                                    <button id="reset-position-btn" class="reset-button" title="입력값 초기화">초기화</button>
                                </div>
                            </td>
                        </tr>
                        <tr><td>총 투자금액 ($)</td><td data-label="금액 ($)"><input type="text" id="balance" placeholder="1,000"></td></tr>
                        <tr>
                            <td>손절매 (%) <div class="description-text">포지션 규모 계산에 사용</div></td>
                            <td data-label="손절매 (%)"><input type="number" id="stopLoss" placeholder="2.5"></td>
                        </tr>
                        <tr>
                            <td>위험 수준 (%) <div class="description-text">총 자산 대비 이번 거래에서 허용 손실</div></td>
                            <td data-label="위험 수준 (%)"><input type="number" id="riskLevel" placeholder="1"></td>
                        </tr>
                        <tr><td>레버리지 (x)</td><td data-label="레버리지 (x)"><input type="number" id="leverage" placeholder="20"></td></tr>
                    </tbody>
                </table>

                <button id="save-position-history-btn" class="action-button save-button">계산 내역 저장</button>
                <div id="position-error" class="error-message"></div>

                <div class="results-section">
                    <h2>계산 결과</h2>
                    <table class="responsive-table">
                        <tbody>
                            <tr><td>최대 손실 ($)</td><td id="maxLoss" class="auto-field"></td></tr>
                            <tr><td>총 포지션 규모 ($)</td><td id="positionSize" class="auto-field"></td></tr>
                            <tr><td>필수 증거금 ($)</td><td id="requiredMargin" class="auto-field"></td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="explanation-section">
                    <h2>입력 설명</h2>
                    <p><b>총 투자금액 ($):</b> 레버리지 제외 실제 계좌자산</p>
                    <p><b>손절매 (%):</b> 손절폭이 좁을수록 포지션 규모는 커짐</p>
                    <p><b>위험 수준 (%):</b> 이번 거래에서 감수할 최대 손실 비율</p>
                    <p><b>레버리지 (x):</b> 포지션/증거금 비율</p>
                </div>
            </div>

            <!-- ===== 3) 수익률 계산기(신규) ===== -->
            <div id="roiCalculator" class="calculator-content">
                <h1>수익률 계산기 (목표가 기준)</h1>
                <table class="responsive-table">
                    <tbody>
                        <tr>
                            <td>투자 종목</td>
                            <td class="no-label">
                                <div class="input-with-button">
                                    <input type="text" id="roi-item" placeholder="예: BTCUSDT, NVDA">
                                    <button id="reset-roi-btn" class="reset-button" title="입력값 초기화">초기화</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>매매 방향</td>
                            <td data-label="매매 방향">
                                <select id="roi-side">
                                    <option value="long" selected>롱 (상승)</option>
                                    <option value="short">숏 (하락)</option>
                                </select>
                            </td>
                        </tr>
                        <tr><td>진입가</td><td data-label="진입가"><input type="text" id="roi-entry" placeholder="예: 10,000"></td></tr>
                        <tr><td>목표가</td><td data-label="목표가"><input type="text" id="roi-target" placeholder="예: 10,500"></td></tr>
                        <tr><td>매수 금액</td><td data-label="매수 금액"><input type="text" id="roi-amount" placeholder="예: 5,000"></td></tr>
                        <tr>
                            <td>왕복 수수료 (%)</td>
                            <td data-label="수수료 (%)"><input type="number" id="roi-fee" placeholder="0.1" step="0.01"></td>
                        </tr>
                        <tr>
                            <td>레버리지 (선택)</td>
                            <td data-label="레버리지 (x)"><input type="number" id="roi-lev" placeholder="예: 10"></td>
                        </tr>
                    </tbody>
                </table>

                <button id="save-roi-history-btn" class="action-button save-button">계산 내역 저장</button>
                <div id="roi-error" class="error-message"></div>

                <div class="results-section">
                    <h2>계산 결과</h2>
                    <table class="responsive-table">
                        <tbody>
                            <tr><td>예상 손익 (P&L)</td><td id="roi-pnl" class="auto-field"></td></tr>
                            <tr><td>수익률 (명목/노미널)</td><td id="roi-ret-notional" class="auto-field"></td></tr>
                            <tr><td>수익률 (증거금 기준)</td><td id="roi-ret-margin" class="auto-field"></td></tr>
                            <tr><td>손익분기점(수수료 반영)</td><td id="roi-bep" class="auto-field"></td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="explanation-section">
                    <h2>설명</h2>
                    <p><b>P&L:</b> (목표가 − 진입가) × 수량 (숏은 부호 반대) − 왕복 수수료. (수량 = 매수 금액 / 진입가)</p>
                    <p><b>왕복 수수료:</b> (매수 금액 + 매도 금액) × (수수료%/100).</p>
                    <p><b>수익률(노미널):</b> P&L ÷ 매수 금액.</p>
                    <p><b>수익률(증거금):</b> 레버리지 입력 시 P&L ÷ (매수 금액 ÷ 레버리지).</p>
                    <p><b>손익분기점:</b> 수수료까지 고려해 P&L=0 이 되는 목표가. (롱/숏 각각 방향성 반영)</p>
                </div>
            </div>
        </div>

        <!-- ===== 내역 영역 ===== -->
        <div class="history-container" id="history-container">
            <h2 id="history-title">계산 내역</h2>
            <div class="history-list" id="history-list"></div>
            <button id="clear-history-btn" class="clear-history-btn">내역 전체 삭제</button>
        </div>
    </div>

    <script>
        /* ===== 공통 숫자 포맷 ===== */
        const unformat = (v) => (v === null || v === undefined) ? '' : String(v).replace(/,/g, '');
        function formatNumber(value) {
            if (value === null || value === undefined || value === '') return '';
            const s = String(value);
            const parts = s.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }
        
        /* ===== 공통 내역 관리 ===== */
        function saveHistory(key, entryData) {
            const historyEntry = { id: Date.now(), date: new Date().toLocaleString('ko-KR'), ...entryData };
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            history.unshift(historyEntry);
            localStorage.setItem(key, JSON.stringify(history));
        }

        function loadHistory(key, listElement, restoreFn) {
            listElement.innerHTML = '';
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            if (history.length === 0) {
                listElement.innerHTML = '<p style="text-align:center;color:#999;">저장된 내역이 없습니다.</p>';
                return;
            }
            history.forEach(entry => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                const sideTag = entry.side === 'long' ? '(롱)' : entry.side === 'short' ? '(숏)' : '';
                itemDiv.innerHTML = `<span class="history-item-title">${entry.item || '이름 없는 계획'} ${sideTag}</span><span class="history-item-date">${entry.date}</span>`;
                itemDiv.onclick = () => restoreFn(entry.id);
                listElement.appendChild(itemDiv);
            });
        }

        function restoreFromHistory(key, id, fieldMap, callback) {
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            const entry = history.find(e => e.id === id);
            if (entry) {
                for (const fieldKey in fieldMap) {
                    const element = document.getElementById(fieldMap[fieldKey]);
                    if (element) {
                        const value = entry[fieldKey] || '';
                        if (['wonCapital', 'usdCapital', 'wonEntry', 'usdEntry', 'wonExit', 'usdExit', 'balance', 'roiEntry', 'roiTarget', 'roiAmount'].includes(fieldKey)) {
                            element.value = formatNumber(value);
                        } else {
                            element.value = value;
                        }
                    }
                }
                if (callback) callback();
                window.scrollTo(0, 0);
            }
        }

        function clearHistory(key, loadFn) {
            localStorage.removeItem(key);
            loadFn();
        }

        function showSaveFeedback(button) {
            const originalText = button.textContent;
            button.textContent = '저장 완료!';
            setTimeout(() => { button.textContent = originalText; }, 1500);
        }
        
        /* ===== 계산기 설정 객체 ===== */
        const calculators = {
            riskCalculator: {
                historyKey: 'riskInvestmentHistory', title: '계산 내역 (리스크 관리)',
                fields: {
                    item: 'investment-item', wonCapital: 'won-total-capital', usdCapital: 'usd-total-capital',
                    wonRisk: 'won-risk-percent', usdRisk: 'usd-risk-percent', wonEntry: 'won-entry',
                    usdEntry: 'usd-entry', wonExit: 'won-exit', usdExit: 'usd-exit',
                    wonCost: 'won-cost', usdCost: 'usd-cost'
                },
                loadFn: () => loadHistory(calculators.riskCalculator.historyKey, document.getElementById('history-list'), calculators.riskCalculator.restoreFn),
                restoreFn: (id) => restoreFromHistory(calculators.riskCalculator.historyKey, id, calculators.riskCalculator.fields, calculateRisk),
                clearFn: () => clearHistory(calculators.riskCalculator.historyKey, calculators.riskCalculator.loadFn),
                saveFn: (btn) => {
                    const entryData = {};
                    for (const key in calculators.riskCalculator.fields) entryData[key] = unformat(document.getElementById(calculators.riskCalculator.fields[key]).value);
                    saveHistory(calculators.riskCalculator.historyKey, entryData);
                    calculators.riskCalculator.loadFn();
                    showSaveFeedback(btn);
                }
            },
            positionCalculator: {
                historyKey: 'positionHistory', title: '계산 내역 (포지션 크기)',
                fields: { item: 'position-item', balance: 'balance', stopLoss: 'stopLoss', riskLevel: 'riskLevel', leverage: 'leverage' },
                loadFn: () => loadHistory(calculators.positionCalculator.historyKey, document.getElementById('history-list'), calculators.positionCalculator.restoreFn),
                restoreFn: (id) => restoreFromHistory(calculators.positionCalculator.historyKey, id, calculators.positionCalculator.fields, () => calculatePosition(false)),
                clearFn: () => clearHistory(calculators.positionCalculator.historyKey, calculators.positionCalculator.loadFn),
                saveFn: (btn) => {
                    if (calculatePosition(true)) {
                        const entryData = {};
                        for (const key in calculators.positionCalculator.fields) entryData[key] = unformat(document.getElementById(calculators.positionCalculator.fields[key]).value);
                        saveHistory(calculators.positionCalculator.historyKey, entryData);
                        calculators.positionCalculator.loadFn();
                        showSaveFeedback(btn);
                    }
                }
            },
            roiCalculator: {
                historyKey: 'roiHistory', title: '계산 내역 (수익률)',
                fields: { item: 'roi-item', side: 'roi-side', entry: 'roi-entry', target: 'roi-target', amount: 'roi-amount', fee: 'roi-fee', lev: 'roi-lev'},
                loadFn: () => loadHistory(calculators.roiCalculator.historyKey, document.getElementById('history-list'), calculators.roiCalculator.restoreFn),
                restoreFn: (id) => restoreFromHistory(calculators.roiCalculator.historyKey, id, calculators.roiCalculator.fields, () => calculateROI(false)),
                clearFn: () => clearHistory(calculators.roiCalculator.historyKey, calculators.roiCalculator.loadFn),
                saveFn: (btn) => {
                    if (calculateROI(true)) {
                        const entryData = {};
                        for (const key in calculators.roiCalculator.fields) entryData[key] = unformat(document.getElementById(calculators.roiCalculator.fields[key]).value);
                        saveHistory(calculators.roiCalculator.historyKey, entryData);
                        calculators.roiCalculator.loadFn();
                        showSaveFeedback(btn);
                    }
                }
            }
        };

        /* ===== 탭 전환 ===== */
        function showCalculator(calculatorId) {
            document.querySelectorAll('.calculator-content, .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(calculatorId).classList.add('active');
            document.querySelector(`.tab-btn[onclick="showCalculator('${calculatorId}')"]`).classList.add('active');
            
            const config = calculators[calculatorId];
            if (config) {
                document.getElementById('history-container').style.display = 'block';
                document.getElementById('history-title').textContent = config.title;
                document.getElementById('clear-history-btn').onclick = config.clearFn;
                config.loadFn();
            }
        }

        /* ===== 계산 로직들 ===== */
        function calculateRisk() {
            const wonTotal = parseFloat(unformat(document.getElementById('won-total-capital').value)) || 0;
            const wonRiskP = parseFloat(unformat(document.getElementById('won-risk-percent').value)) || 0;
            const wonEntry = parseFloat(unformat(document.getElementById('won-entry').value)) || 0;
            const wonExit  = parseFloat(unformat(document.getElementById('won-exit').value)) || 0;
            const wonCostP = parseFloat(unformat(document.getElementById('won-cost').value)) || 0;

            const wonStopAmt = wonTotal * (wonRiskP / 100);
            document.getElementById('won-stop-loss-amount').textContent = wonStopAmt.toLocaleString('ko-KR', { maximumFractionDigits: 0 });

            if (wonEntry > 0 && wonExit > 0) {
                const priceLossRate = Math.abs(wonEntry - wonExit) / wonEntry;
                const costRate = wonCostP / 100;
                const totalLossRate = priceLossRate + costRate;
                document.getElementById('won-stop-loss-percent').textContent = (totalLossRate * 100).toFixed(2) + '%';
                const invest = totalLossRate > 0 ? (wonStopAmt / totalLossRate) : 0;
                document.getElementById('won-investment').textContent = Math.round(invest).toLocaleString('ko-KR');
            } else {
                document.getElementById('won-stop-loss-percent').textContent = '---';
                document.getElementById('won-investment').textContent = '---';
            }

            const usdTotal = parseFloat(unformat(document.getElementById('usd-total-capital').value)) || 0;
            const usdRiskP = parseFloat(unformat(document.getElementById('usd-risk-percent').value)) || 0;
            const usdEntry = parseFloat(unformat(document.getElementById('usd-entry').value)) || 0;
            const usdExit  = parseFloat(unformat(document.getElementById('usd-exit').value)) || 0;
            const usdCostP = parseFloat(unformat(document.getElementById('usd-cost').value)) || 0;

            const usdStopAmt = usdTotal * (usdRiskP / 100);
            document.getElementById('usd-stop-loss-amount').textContent = usdStopAmt.toLocaleString('en-US', { maximumFractionDigits: 2 });

            if (usdEntry > 0 && usdExit > 0) {
                const priceLossRateUSD = Math.abs(usdEntry - usdExit) / usdEntry;
                const costRateUSD = usdCostP / 100;
                const totalLossRateUSD = priceLossRateUSD + costRateUSD;
                document.getElementById('usd-stop-loss-percent').textContent = (totalLossRateUSD * 100).toFixed(2) + '%';
                const investUSD = totalLossRateUSD > 0 ? (usdStopAmt / totalLossRateUSD) : 0;
                document.getElementById('usd-investment').textContent = Math.round(investUSD).toLocaleString('en-US');
            } else {
                document.getElementById('usd-stop-loss-percent').textContent = '---';
                document.getElementById('usd-investment').textContent = '---';
            }
        }

        function calculatePosition(shouldWarn = true) {
            const balance = parseFloat(unformat(document.getElementById('balance').value)) || 0;
            const slP = parseFloat(unformat(document.getElementById('stopLoss').value)) || 0;
            const riskP = parseFloat(unformat(document.getElementById('riskLevel').value)) || 0;
            const lev = parseFloat(unformat(document.getElementById('leverage').value)) || 0;
            const err = document.getElementById('position-error');
            
            const resultsIds = ['maxLoss', 'positionSize', 'requiredMargin'];
            
            if (balance <= 0 || slP <= 0 || riskP <= 0 || lev < 1) {
                if (shouldWarn && (document.getElementById('balance').value || document.getElementById('stopLoss').value || document.getElementById('riskLevel').value) ) {
                    err.textContent = '모든 필드에 유효한 숫자를 입력해주세요.'; setTimeout(() => { err.textContent = '' }, 3000);
                }
                resultsIds.forEach(id => document.getElementById(id).textContent = '');
                return false;
            }
            err.textContent = '';
            const maxLoss = balance * (riskP / 100);
            const positionSize = maxLoss / (slP / 100);
            const requiredMargin = positionSize / lev;

            document.getElementById('maxLoss').textContent = `$${maxLoss.toLocaleString('en-US', { maximumFractionDigits: 2 })}`;
            document.getElementById('positionSize').textContent = `$${positionSize.toLocaleString('en-US', { maximumFractionDigits: 2 })}`;
            document.getElementById('requiredMargin').textContent = `$${requiredMargin.toLocaleString('en-US', { maximumFractionDigits: 2 })}`;
            return true;
        }

        function calculateROI(shouldWarn = true) {
            const side = document.getElementById('roi-side').value;
            const entry = parseFloat(unformat(document.getElementById('roi-entry').value)) || 0;
            const target = parseFloat(unformat(document.getElementById('roi-target').value)) || 0;
            const amount = parseFloat(unformat(document.getElementById('roi-amount').value)) || 0;
            const feeP = parseFloat(unformat(document.getElementById('roi-fee').value)) || 0;
            const lev = parseFloat(unformat(document.getElementById('roi-lev').value)) || null;
            const err = document.getElementById('roi-error');
            
            const qty = (entry > 0) ? (amount / entry) : 0;

            if (entry <= 0 || target <= 0 || amount <= 0 || feeP < 0) {
                 if (shouldWarn && (document.getElementById('roi-entry').value || document.getElementById('roi-target').value || document.getElementById('roi-amount').value)) {
                    err.textContent = '진입가/목표가/매수 금액을 올바르게 입력해주세요.'; setTimeout(() => { err.textContent = '' }, 3000);
                 }
                clearROIResults(); return false;
            }
            err.textContent = '';

            let gross = (side === 'short') ? (entry - target) * qty : (target - entry) * qty;
            const exitAmount = target * qty;
            const fee = (amount + exitAmount) * (feeP / 100);
            const pnl = gross - fee;
            
            const retNotional = amount > 0 ? (pnl / amount) : 0;
            
            let retMargin = null;
            if (lev && lev > 0) {
                const margin = amount / lev;
                retMargin = margin > 0 ? (pnl / margin) : null;
            }

            const f = feeP / 100;
            let bep = (side === 'long') ? (entry * (1 + f)) / (1 - f) : (entry * (1 - f)) / (1 + f);

            document.getElementById('roi-pnl').textContent = `$${pnl.toLocaleString('en-US', { maximumFractionDigits: 2 })}`;
            document.getElementById('roi-ret-notional').textContent = `${(retNotional * 100).toFixed(2)}%`;
            document.getElementById('roi-ret-margin').textContent = (retMargin === null) ? '—' : `${(retMargin * 100).toFixed(2)}%`;
            document.getElementById('roi-bep').textContent = `${bep.toLocaleString('en-US', { maximumFractionDigits: 6 })}`;
            return true;
        }
        function clearROIResults() {
            ['roi-pnl', 'roi-ret-notional', 'roi-ret-margin', 'roi-bep'].forEach(id => document.getElementById(id).textContent = '');
        }

        /* ===== 초기화 및 이벤트 리스너 ===== */
        function resetPrices() {
            ['won-entry', 'usd-entry', 'won-exit', 'usd-exit'].forEach(id => document.getElementById(id).value = '');
            calculateRisk();
        }
        function resetPositionInputs() {
            ['position-item', 'balance', 'stopLoss', 'riskLevel', 'leverage'].forEach(id => document.getElementById(id).value = '');
            calculatePosition(false);
        }
        function resetROIInputs() {
            document.getElementById('roi-item').value = '';
            document.getElementById('roi-side').value = 'long';
            ['roi-entry', 'roi-target', 'roi-amount', 'roi-fee', 'roi-lev'].forEach(id => {
                const el = document.getElementById(id);
                el.value = (id === 'roi-fee') ? '0.1' : '';
            });
            clearROIResults();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('save-risk-history-btn').addEventListener('click', (e) => calculators.riskCalculator.saveFn(e.target));
            document.getElementById('save-position-history-btn').addEventListener('click', (e) => calculators.positionCalculator.saveFn(e.target));
            document.getElementById('save-roi-history-btn').addEventListener('click', (e) => calculators.roiCalculator.saveFn(e.target));

            document.getElementById('reset-prices-btn').addEventListener('click', resetPrices);
            document.getElementById('reset-position-btn').addEventListener('click', resetPositionInputs);
            document.getElementById('reset-roi-btn').addEventListener('click', resetROIInputs);

            document.querySelectorAll('#riskCalculator input').forEach(inp => inp.addEventListener('input', calculateRisk));
            document.querySelectorAll('#positionCalculator input').forEach(inp => inp.addEventListener('input', () => calculatePosition(false)));
            document.querySelectorAll('#roiCalculator input, #roiCalculator select').forEach(inp => inp.addEventListener('input', () => calculateROI(false)));

            const inputsToFormat = ['won-total-capital', 'usd-total-capital', 'won-entry', 'usd-entry', 'won-exit', 'usd-exit', 'balance', 'roi-entry', 'roi-target', 'roi-amount'];
            inputsToFormat.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.type = 'text'; el.setAttribute('inputmode', 'decimal');
                    el.addEventListener('input', (e) => {
                        const orig = e.target.value; const raw = unformat(orig);
                        if (isNaN(raw) && raw !== '' && raw !== '.') { e.target.value = orig.slice(0, -1); return; }
                        const fmt = formatNumber(raw);
                        if (orig !== fmt) e.target.value = fmt;
                    });
                }
            });

            showCalculator('riskCalculator');
            calculateRisk();
        });
    </script>
</body>
</html>

